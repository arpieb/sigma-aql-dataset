SELECT * FROM events WHERE devicetype=12 AND (LOWER("Process Path") LIKE '%\powershell.exe' OR LOWER("Process Path") LIKE '%\pwsh.exe' OR LOWER("Process Name") LIKE '%\powershell.exe' OR LOWER("Process Name") LIKE '%\pwsh.exe' OR Filename IN('PowerShell.EXE', 'pwsh.dll')) AND LOWER(Command) LIKE '%add-pssnapin%' AND (LOWER(Command) LIKE '%microsoft.exchange.powershell.snapin%' OR LOWER(Command) LIKE '%microsoft.exchange.management.powershell.snapin%') AND NOT(("Parent Process Path"='C:\Windows\System32\msiexec.exe' AND LOWER(Command) LIKE '%$exserver=get-exchangeserver ([environment]::machinename) -errorvariable exerr 2> $null%'))